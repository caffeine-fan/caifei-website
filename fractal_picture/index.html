<html>
    <head>
<style>
    body {
        background-color: gray;
        height:100%;
        width: 100%;
    }
    #container {
        width: 100%;
        height:100%;
        display:flex;
        flex-direction: column;
        flex-wrap: wrap;
    }
    #animation_container {
        flex-grow: 3;
    }
    .entry1 {
        background-color: red;
    }
    #control_container {
        flex-grow:1;
        flex-direction: column;
        background-color: red;
        height:100%;
    }
    .control {
        height:18%;
        background-color: blue;
        margin-bottom: 2%
        
    }
    .matrix_form {
          display: inline-grid;
          grid-template-columns: 1fr 1fr;
          grid-gap: 5px;
    }
    .vector_form {
          display: inline-grid;
          grid-template-columns: 1fr;
          grid-gap: 5px;
    }
    .add_control {
          display: flex;
          align-items: center;
            justify-content: center;
    }
    input {
        height: 20px;
        width: 30px;
        font-size: 10px;
    }
    .svg-circleplus { height: 40px; stroke: black; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.6.3/math.js"></script>
    </head>
    <body>
        <div id = "container">
            <div id = "animation_container">
                <canvas id="animation"></canvas>
            </div>
            <div id = "control_container">
                <div class = "control" onfocusin="pauseAnimation()" onfocusout="startAnimation()">
                    <form class="matrix_form" >
                        <input type="text" size="5" value="cos(t)/sqrt(2)"  id="matrix111">
                        <input type="text" size="5" value="-sin(t)/sqrt(2)" id="matrix112">
                        <input type="text" size="5" value="sin(t)/sqrt(2)"  id="matrix121">
                        <input type="text" size="5" value="cos(t)/sqrt(2)"  id="matrix122">
                    </form>
                    +
                    <form class="vector_form">
                        <input type="text" size="5" value="10" id="vector11">
                        <input type="text" size="5" value="0"  id="vector12">
                    </form>
                </div>
                <div class = "control"  id="input2" onfocusin="pauseAnimation()" onfocusout="startAnimation()">
                    <form class="matrix_form">
                        <input type="text" size="5" value="cos(t+2)/sqrt(2)"  id="matrix211">
                        <input type="text" size="5" value="-sin(t+2)/sqrt(2)" id="matrix212">
                        <input type="text" size="5" value="sin(t+2)/sqrt(2)"  id="matrix221">
                        <input type="text" size="5" value="cos(t+2)/sqrt(2)"  id="matrix222">
                    </form>
                    +
                    <form class="vector_form">
                        <input type="text" size="5" value="0" id="vector21">
                        <input type="text" size="5" value="0" id="vector22">
                    </form>
                </div>
                <div class = "add_control">
                    <svg class="svg-circleplus" viewBox="0 0 100 100" onclick="addTransforms">
  <circle cx="50" cy="50" r="45" fill="none" stroke-width="7.5"></circle>
  <line x1="32.5" y1="50" x2="67.5" y2="50" stroke-width="5"></line>
  <line x1="50" y1="32.5" x2="50" y2="67.5" stroke-width="5"></line>
</svg>

                </div>
            </div>
        </div>
    <script>
// Canvas elements
var mainCanvas = document.getElementById("animation");
var mainContext = mainCanvas.getContext('2d');

// Methods for starting/stopping animations.
var requestAnimationFrame = window.requestAnimationFrame ||
                            window.mozRequestAnimationFrame ||
                            window.webkitRequestAnimationFrame ||
                            window.msRequestAnimationFrame;

var cancelAnimationFrame = window.cancelAnimationFrame || window.mozCancelAnimationFrame;

// Utility functions
// Copied from https://stackoverflow.com/questions/17242144/javascript-convert-hsb-hsv-color-to-rgb-accurately
function HSVtoRGB(h, s, v) {
    var r, g, b, i, f, p, q, t;
    if (arguments.length === 1) {
        s = h.s, v = h.v, h = h.h;
    }
    i = Math.floor(h * 6);
    f = h * 6 - i;
    p = v * (1 - s);
    q = v * (1 - f * s);
    t = v * (1 - (1 - f) * s);
    switch (i % 6) {
        case 0: r = v, g = t, b = p; break;
        case 1: r = q, g = v, b = p; break;
        case 2: r = p, g = v, b = t; break;
        case 3: r = p, g = q, b = v; break;
        case 4: r = t, g = p, b = v; break;
        case 5: r = v, g = p, b = q; break;
    }
    return "#" + Math.round(r * 255).toString(16) + Math.round(g * 255).toString(16) + Math.round(b * 255).toString(16);
}

function evaluateMatrix(matrix, time) {
    return matrix.map(x => (evaluateVector(x, time)));
}
function evaluateVector(vector, time) {
    return vector.map(x => x.evaluate({t:time}));
}

// Global variables.
var DEPTH = 12;
var TRANSFORMS = 2;
var SIZE = TRANSFORMS ** DEPTH;
var DELTA_T = 0.1;
var COLORS = new Array(SIZE);
for (let i = 0; i < SIZE; i++) {
    COLORS[i] = HSVtoRGB(i / SIZE, 0.75, 0.8);
}

var points = new Array(SIZE);
var time = 0;

var matrices = [0,0];
var offsets = [0,0];

function addTransform() {
    TRANSFORMS += 1;
    SIZE = TRANSFORMS ** DEPTH;
    points = new Array(SIZE);
}

function drawCircle(x, y, r, color) {
    mainContext.beginPath();
    mainContext.arc(x, y, r, 0, Math.PI * 2, false);
    mainContext.closePath();

    // color in the circle
    mainContext.fillStyle = color;
    mainContext.fill();
}

function newPoints() {
    points[0] = [10,0];
    for(let iter = 0; iter < DEPTH; iter++) {
        var rounds = TRANSFORMS ** iter;
        for (let j = 0; j < rounds; j++) {
            for(let k = TRANSFORMS - 1;  k >= 0; k--) {
                points[k * rounds + j] =
                    math.add(
                        math.multiply(evaluateMatrix(matrices[k], time), points[j]),
                        evaluateVector(offsets[k], time));
            }
        }
    }
}

function updateFractal() {
    var canvasWidth = mainCanvas.width;
    var canvasHeight = mainCanvas.height;

    mainContext.clearRect(0, 0, canvasWidth, canvasHeight);

    // color in the background
    mainContext.fillStyle = "#EEEEEE";
    mainContext.fillRect(0, 0, canvasWidth, canvasHeight);
    
    newPoints();

    var offset = [canvasWidth / 2, canvasHeight / 2];
    for(let i = 0; i < SIZE; i++) {
        offset[0] -= 3*points[i][0] / SIZE;
        offset[1] -= 3*points[i][1] / SIZE;
    }

    for(let i = 0; i < SIZE; i++) {
        drawCircle(3*points[i][0] + offset[0], 3*points[i][1] + offset[1], 1, COLORS[i]);
    }
}

function doAnimation() {
    updateFractal();
    time += DELTA_T;
    eventid = requestAnimationFrame(doAnimation);
}

function getMatrix(index) {
    let matrix = [[0,0],[0,0]];
    for(let i = 1; i <= 2; i++) {
        for(let j = 1; j <= 2; j++) {
            matrix[i-1][j-1] = math.compile(
                document.getElementById("matrix"+String(index)+String(i)+String(j)).value);
        }
    }
    return matrix;
}

function getVector(index) {
    let vector = [0,0]
    for(let i = 1; i <= 2; i++) {
        vector[i-1] = math.compile(
            document.getElementById("vector"+String(index)+String(i)).value);
    }
    return vector;
}

function startAnimation() {
    matrices = []
    offsets = []
    for (let i = 1; i <= TRANSFORMS; i++) {
        matrices.push(getMatrix(i));
        offsets.push(getVector(i));
    }
    time = 0;
    eventid = requestAnimationFrame(doAnimation);
}

// cancelAnimationFrame(eventid) will stop the animation from running.

function fix_dpi() {
//get CSS height
//the + prefix casts it to an integer
//the slice method gets rid of "px"
let style_height = +getComputedStyle(mainCanvas).getPropertyValue("height").slice(0, -2);//get CSS width
let style_width = +getComputedStyle(mainCanvas).getPropertyValue("width").slice(0, -2);//scale the mainCanvas
mainCanvas.setAttribute('height', style_height * 2);
mainCanvas.setAttribute('width', style_width * 2);}
window.onload = function() {
    fix_dpi();
    startAnimation();
}

function pauseAnimation() {
    cancelAnimationFrame(eventid);
}
    </script>
    </body>
</html>

